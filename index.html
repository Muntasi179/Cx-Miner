<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>CX Miner</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root{
    --font:'Poppins',sans-serif;--bg:#0d0a1f;--primary:#fff;--secondary:#ff8c00;
    --text:#f1f1f1;--muted:#aaa;--card:rgba(255,255,255,.08);--border:rgba(255,255,255,.2);
    --radius:16px;--t:.3s ease;--success:#4CAF50;--warning:#FF9800;--danger:#f44336;
  }
  *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
  html,body{height:100%;margin:0}
  body{font-family:var(--font);background:linear-gradient(135deg,#0d0a1f,#1f0a2e,#0d0a1f);
       background-size:400% 400%;animation:bg 15s ease infinite;color:var(--text);
       display:flex;align-items:center;justify-content:center;overflow:hidden}
  @keyframes bg{0%{background-position:0 50%}50%{background-position:100% 50%}100%{background-position:0 50%}}
  .app{width:100%;max-width:480px;height:100%;display:flex;flex-direction:column;background:rgba(13,10,31,.5);backdrop-filter:blur(15px);position:relative;overflow:hidden}
  .top{padding:15px 20px;display:flex;justify-content:space-between;align-items:center}
  .profile{display:flex;align-items:center;gap:10px;cursor:pointer}
  .profile img{width:40px;height:40px;border-radius:50%;border:2px solid var(--primary)}
  .points{padding:10px 20px;text-align:center;margin-top:-10px}
  .balance{font-size:2.2rem;font-weight:700;display:flex;gap:10px;align-items:center;justify-content:center;text-shadow:0 0 15px var(--primary)}
  .logo-small{width:40px;height:40px;animation:pulse 2s infinite}
  @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
  .zone{flex:1;display:flex;align-items:center;justify-content:center;position:relative}
  .logo-big{width:280px;height:280px;animation:spin-pulse 3s ease-in-out infinite;position:absolute;top:50%;left:50%;transform:translate(-50%, -50%);}
  @keyframes spin-pulse{
    0%{transform:translate(-50%, -50%) scale(1) rotate(0deg);filter:drop-shadow(0 0 5px var(--secondary))}
    50%{transform:translate(-50%, -50%) scale(1.1) rotate(5deg);filter:drop-shadow(0 0 20px var(--secondary))}
    100%{transform:translate(-50%, -50%) scale(1) rotate(0deg);filter:drop-shadow(0 0 5px var(--secondary))}
  }
  .float{position:absolute;font-size:1.8rem;font-weight:600;color:var(--primary);pointer-events:none;animation:rise 1.5s ease-out forwards;text-shadow:0 0 10px var(--primary)}
  @keyframes rise{to{transform:translateY(-100px);opacity:0}}
  .error-float{position:absolute;font-size:1.4rem;font-weight:600;color:#ff4444;pointer-events:none;animation:shake 1s ease-out forwards;text-shadow:0 0 10px #ff0000}
  @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-10px)}75%{transform:translateX(10px)}}
  .bottom{padding:15px 20px}
  .energy-info{display:flex;justify-content:space-between;font-size:.85rem;color:var(--muted)}
  .bar{width:100%;height:15px;border-radius:10px;border:1px solid var(--border);background:rgba(0,0,0,.3);overflow:hidden;margin:8px 0 15px}
  .fill{height:100%;background:linear-gradient(90deg,var(--secondary),var(--primary));transition:width .5s;box-shadow:0 0 15px var(--primary)}
  .nav{display:flex;justify-content:space-around;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:10px 0}
  .nav .item{display:flex;flex-direction:column;align-items:center;gap:5px;font-size:.75rem;color:var(--muted);cursor:pointer;transition:var(--t)}
  .nav .item:hover{color:var(--primary);transform:translateY(-4px);text-shadow:0 0 10px var(--primary)}
  .modal{position:absolute;inset:0;background:rgba(0,0,0,.6);display:flex;justify-content:center;align-items:flex-end;opacity:0;pointer-events:none;transition:.3s;z-index:1000}
  .modal.show{opacity:1;pointer-events:auto}
  .sheet{width:100%;background:var(--bg);border-top:2px solid var(--primary);border-radius:20px 20px 0 0;padding:20px;transform:translateY(100%);transition:.3s;max-height:90vh;overflow-y:auto}
  .modal.show .sheet{transform:translateY(0)}
  .sheet .head{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  .close{background:none;border:none;color:var(--muted);font-size:1.4rem;cursor:pointer}
  .wallet-row{display:flex;align-items:center;justify-content:center;gap:10px;font-size:2rem;font-weight:700;margin:20px 0}
  .btn{background:linear-gradient(90deg,var(--secondary),var(--primary));color:#000;border:none;border-radius:8px;padding:10px 14px;font-weight:700;cursor:pointer;transition:var(--t)}
  .btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(255,140,0,0.4)}
  .btn[disabled]{background:#555;color:#999;cursor:not-allowed;transform:none;box-shadow:none}
  .list{display:flex;flex-direction:column;gap:12px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px;display:flex;align-items:center;justify-content:space-between}
  .card .info{display:flex;gap:10px;align-items:center}
  
  /* New styles */
  .particles{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:0}
  .particle{position:absolute;background:var(--secondary);border-radius:50%;opacity:0;animation:particle-float 8s linear infinite}
  @keyframes particle-float{
    0%{transform:translateY(100vh) rotate(0deg);opacity:1}
    100%{transform:translateY(-100px) rotate(360deg);opacity:0}
  }
  .stats-bar{display:flex;justify-content:space-around;padding:10px 15px;background:var(--card);border-radius:var(--radius);margin:0 20px 15px;border:1px solid var(--border)}
  .stat{display:flex;flex-direction:column;align-items:center;font-size:0.8rem}
  .stat-value{font-weight:bold;color:var(--primary);font-size:1.1rem}
  .stat-label{color:var(--muted);font-size:0.7rem}
  .tap-effects{position:absolute;width:100%;height:100%;pointer-events:none;z-index:1}
  .tap-effect{position:absolute;width:80px;height:80px;background:radial-gradient(circle, rgba(255,140,0,0.8) 0%, rgba(255,140,0,0) 70%);border-radius:50%;transform:translate(-50%, -50%);pointer-events:none;animation:tap-effect 0.5s ease-out forwards}
  @keyframes tap-effect{
    0%{transform:translate(-50%, -50%) scale(0);opacity:1}
    100%{transform:translate(-50%, -50%) scale(2);opacity:0}
  }
  .achievement-toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--success);color:white;padding:10px 20px;border-radius:30px;display:flex;align-items:center;gap:10px;z-index:1001;box-shadow:0 5px 15px rgba(0,0,0,0.2);animation:toast-in 0.5s ease, toast-out 0.5s ease 2.5s forwards}
  @keyframes toast-in{from{opacity:0;transform:translate(-50%, 100px)}to{opacity:1;transform:translate(-50%, 0)}}
  @keyframes toast-out{from{opacity:1;transform:translate(-50%, 0)}to{opacity:0;transform:translate(-50%, 100px)}}
  .upgrade-badge{position:absolute;top:10px;right:10px;background:var(--warning);color:#000;font-size:0.7rem;padding:2px 6px;border-radius:10px;font-weight:bold;animation:badge-pulse 1s infinite}
  @keyframes badge-pulse{0%,100%{opacity:1}50%{opacity:0.5}}
  .progress-ring{transform:rotate(-90deg);position:absolute;top:50%;left:50%;transform:translate(-50%, -50%) rotate(-90deg);}
  .progress-ring-circle{transition:stroke-dashoffset 0.5s;transform-origin:50% 50%}
  .shop-item{display:flex;flex-direction:column;gap:8px;padding:12px;background:var(--card);border-radius:var(--radius);border:1px solid var(--border)}
  .shop-item-header{display:flex;justify-content:space-between;align-items:center}
  .shop-item-name{font-weight:bold}
  .shop-item-price{color:var(--secondary);font-weight:bold}
  .shop-item-desc{font-size:0.85rem;color:var(--muted)}
  .shop-item-button{width:100%;margin-top:5px}
  .tab-container{margin-bottom:15px}
  .tabs{display:flex;gap:5px;border-bottom:1px solid var(--border)}
  .tab{padding:8px 15px;cursor:pointer;border-radius:5px 5px 0 0;transition:var(--t)}
  .tab.active{background:var(--card);border:1px solid var(--border);border-bottom:none}
  .tab-content{display:none}
  .tab-content.active{display:block}
  .multiplier-badge{position:absolute;top:10px;left:10px;background:var(--secondary);color:#000;font-size:0.8rem;padding:3px 8px;border-radius:10px;font-weight:bold;animation:badge-pulse 1s infinite;z-index:10}
  .tapper-zone{position:absolute;width:100%;height:100%;top:0;left:0;z-index:5;cursor:pointer}
  /* Prevent flash on tap */
  .tapper-zone:active, .tapper-zone:focus {
    background: transparent !important;
    outline: none !important;
  }
  /* Shop item styles to match the screenshot */
  .shop-item-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 12px;
  }
  .shop-item-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 14px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .shop-item-title {
    font-weight: bold;
    font-size: 1.1rem;
  }
  .shop-item-price-tag {
    color: var(--secondary);
    font-weight: bold;
    font-size: 1.2rem;
    text-align: right;
  }
  .shop-item-description {
    font-size: 0.85rem;
    color: var(--muted);
    margin-bottom: 8px;
  }
  .social-links {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 15px;
  }
  .social-links a {
    color: var(--muted);
    font-size: 1.2rem;
    transition: var(--t);
  }
  .social-links a:hover {
    color: var(--primary);
    transform: translateY(-2px);
  }
  .ad-cooldown {
    font-size: 0.8rem;
    color: var(--muted);
    text-align: center;
    margin-top: 5px;
  }
  .x-icon {
    display: inline-block;
    width: 16px;
    height: 16px;
    background: currentColor;
    mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 1227'%3E%3Cpath d='M714.163 519.284L1160.89 0H1055.03L667.137 450.887L357.328 0H0L468.492 681.821L0 1226.37H105.866L515.491 750.218L842.672 1226.37H1200L714.137 519.284H714.163ZM569.165 687.828L521.697 619.934L144.011 79.6944H306.615L611.412 515.685L658.88 583.579L1055.08 1150.3H892.476L569.165 687.854V687.828Z'/%3E%3C/svg%3E") no-repeat center;
    -webkit-mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 1227'%3E%3Cpath d='M714.163 519.284L1160.89 0H1055.03L667.137 450.887L357.328 0H0L468.492 681.821L0 1226.37H105.866L515.491 750.218L842.672 1226.37H1200L714.137 519.284H714.163ZM569.165 687.828L521.697 619.934L144.011 79.6944H306.615L611.412 515.685L658.88 583.579L1055.08 1150.3H892.476L569.165 687.854V687.828Z'/%3E%3C/svg%3E") no-repeat center;
  }
</style>
</head>
<body>
  <div class="app">
    <div class="particles" id="particles"></div>
    <div class="tap-effects" id="tapEffects"></div>
    
    <div class="top">
      <div class="profile" id="profileBtn">
        <img id="profilePic" src="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png" alt="">
        <span id="usernameDisplay">User</span>
      </div>
      <div class="item" id="walletBtn" title="Wallet"><i class="fas fa-wallet"></i></div>
    </div>

    <div class="stats-bar">
      <div class="stat">
        <div class="stat-value" id="multitapStat">1</div>
        <div class="stat-label">Multitap</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="energyRegenStat">0.5/s</div>
        <div class="stat-label">Regen</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="totalTapsStat">0</div>
        <div class="stat-label">Total Taps</div>
      </div>
    </div>

    <div class="points">
      <div class="balance">
        <img class="logo-small" src="https://i.postimg.cc/fRwD0tzJ/Adobe-Express-file.png" alt="">
        <span id="pointsBalance">0</span> CX
      </div>
    </div>

    <main class="zone" id="tapperZone">
      <div id="multiplierBadge" class="multiplier-badge" style="display: none;">2x Active</div>
      <img id="tapperObject" class="logo-big" src="https://i.postimg.cc/fRwD0tzJ/Adobe-Express-file.png" alt="CX">
      <div class="progress-ring-container">
        <svg class="progress-ring" width="320" height="320">
          <circle class="progress-ring-circle" stroke="rgba(255,140,0,0.3)" stroke-width="4" fill="transparent" r="158" cx="160" cy="160"/>
        </svg>
      </div>
      <div class="tapper-zone" id="tapperClickArea"></div>
    </main>

    <footer class="bottom">
      <div class="energy-info">
        <span><i class="fas fa-bolt"></i> Energy</span>
        <span id="energyDisplay">10 / 100</span>
      </div>
      <div class="bar"><div id="energyBarFill" class="fill" style="width:10%"></div></div>
      <div class="nav">
        <div class="item" id="boostsBtn"><i class="fas fa-rocket"></i><span>Boosts</span></div>
        <div class="item" id="shopBtn"><i class="fas fa-store"></i><span>Shop</span></div>
        <div class="item" id="tasksBtn"><i class="fas fa-tasks"></i><span>Tasks</span></div>
        <div class="item" id="friendsBtn"><i class="fas fa-users"></i><span>Friends</span></div>
      </div>
    </footer>
  </div>

  <!-- Profile -->
  <div class="modal" id="profileModal">
    <div class="sheet">
      <div class="head"><h3>Profile</h3><button class="close" data-close>&times;</button></div>
      <p><strong>Username:</strong> <span id="profileUsername">User</span></p>
      <p><strong>Total CX:</strong> <span id="profileBalance">0</span></p>
      <p><strong>Energy:</strong> <span id="profileEnergy">10 / 100</span></p>
      <p><strong>Multitap:</strong> <span id="profileMultitap">1</span></p>
      <p><strong>Total Taps:</strong> <span id="profileTaps">0</span></p>
      <p><strong>Play Time:</strong> <span id="profilePlayTime">0m</span></p>
      <div class="social-links">
        <a href="https://t.me/CloneX_Updates" target="_blank" title="Telegram"><i class="fab fa-telegram"></i></a>
        <a href="https://x.com/clonex_updates" target="_blank" title="X (Twitter)"><i class="fab fa-x-twitter"></i></a>
      </div>
    </div>
  </div>

  <!-- Wallet -->
  <div class="modal" id="walletModal">
    <div class="sheet">
      <div class="head"><h3>My Wallet</h3><button class="close" data-close>&times;</button></div>
      <div class="wallet-row">
        <img class="logo-small" src="https://i.postimg.cc/fRwD0tzJ/Adobe-Express-file.png" alt="">
        <span id="walletBalance">0</span> CX
      </div>
      <button class="btn" disabled>Withdraw (Coming Soon)</button>
      <div class="social-links">
        <a href="https://t.me/CloneX_Updates" target="_blank" title="Telegram"><i class="fab fa-telegram"></i></a>
        <a href="https://x.com/clonex_updates" target="_blank" title="X (Twitter)"><i class="fab fa-x-twitter"></i></a>
      </div>
    </div>
  </div>

  <!-- Boosts -->
  <div class="modal" id="boostsModal">
    <div class="sheet">
      <div class="head"><h3>Boosts</h3><button class="close" data-close>&times;</button></div>
      <div class="tab-container">
        <div class="tabs">
          <div class="tab active" data-tab="boosts">Boosts</div>
          <div class="tab" data-tab="achievements">Achievements</div>
        </div>
      </div>
      <div class="tab-content active" id="boostsTab">
        <div id="boostList" class="list"></div>
      </div>
      <div class="tab-content" id="achievementsTab">
        <div id="achievementsList" class="list"></div>
      </div>
      <div class="social-links">
        <a href="https://t.me/CloneX_Updates" target="_blank" title="Telegram"><i class="fab fa-telegram"></i></a>
        <a href="https://x.com/clonex_updates" target="_blank" title="X (Twitter)"><i class="fab fa-x-twitter"></i></a>
      </div>
    </div>
  </div>

  <!-- Shop -->
  <div class="modal" id="shopModal">
    <div class="sheet">
      <div class="head"><h3>Shop</h3><button class="close" data-close>&times;</button></div>
      <div class="tab-container">
        <div class="tabs">
          <div class="tab active" data-tab="autoTappers">Auto Tappers</div>
          <div class="tab" data-tab="energy">Energy</div>
          <div class="tab" data-tab="multipliers">Multipliers</div>
        </div>
      </div>
      <div class="tab-content active" id="autoTappersTab">
        <div id="autoTappersList" class="list"></div>
      </div>
      <div class="tab-content" id="energyTab">
        <div id="energyList" class="list"></div>
      </div>
      <div class="tab-content" id="multipliersTab">
        <div id="multipliersList" class="shop-item-grid"></div>
      </div>
      <div class="social-links">
        <a href="https://t.me/CloneX_Updates" target="_blank" title="Telegram"><i class="fab fa-telegram"></i></a>
        <a href="https://x.com/clonex_updates" target="_blank" title="X (Twitter)"><i class="fab fa-x-twitter"></i></a>
      </div>
    </div>
  </div>

  <!-- Tasks -->
  <div class="modal" id="tasksModal">
    <div class="sheet">
      <div class="head"><h3>Tasks</h3><button class="close" data-close>&times;</button></div>
      <div id="taskList" class="list"></div>
      <div class="social-links">
        <a href="https://t.me/CloneX_Updates" target="_blank" title="Telegram"><i class="fab fa-telegram"></i></a>
        <a href="https://x.com/clonex_updates" target="_blank" title="X (Twitter)"><i class="fab fa-x-twitter"></i></a>
      </div>
    </div>
  </div>

  <!-- Friends -->
  <div class="modal" id="friendsModal">
    <div class="sheet">
      <div class="head"><h3>Invite Friends</h3><button class="close" data-close>&times;</button></div>
      <div class="list">
        <div class="card">
          <div class="info">
            <i class="fas fa-link"></i>
            <div>
              <div>Referral link</div>
              <div id="refLink" style="font-size:.9rem;opacity:.9">http://t.me/Official_CloneX_Bot/clonex?start=</div>
            </div>
          </div>
          <button class="btn" id="copyRef">Copy</button>
        </div>
        <div class="card">
          <div class="info">
            <i class="fas fa-gift"></i>
            <div>
              <div>Friends invited</div>
              <div style="font-size:.9rem;opacity:.9"><span id="friendsCount">0</span> friends</div>
            </div>
          </div>
          <div class="stat-value">+<span id="friendsBonus">0</span>%</div>
        </div>
        <div class="card">
          <div class="info">
            <i class="fas fa-coins"></i>
            <div>
              <div>Referral Bonus</div>
              <div style="font-size:.9rem;opacity:.9">Earn 10% of friends' earnings</div>
            </div>
          </div>
          <div class="stat-value"><span id="refEarnings">0</span> CX</div>
        </div>
      </div>
      <div class="social-links">
        <a href="https://t.me/CloneX_Updates" target="_blank" title="Telegram"><i class="fab fa-telegram"></i></a>
        <a href="https://x.com/clonex_updates" target="_blank" title="X (Twitter)"><i class="fab fa-x-twitter"></i></a>
      </div>
    </div>
  </div>

<script>
(function(){
  // Game state with default values for new users
  let points = 0;
  let energy = 10;
  let maxEnergy = 100;
  let multitap = 1;
  let adCooldown = false;
  let adTimer = 0;
  let adInterval = null;
  let completedTasks = [];
  let boostsLevel = { multitap: 1, energy: 1, regen: 1 };
  let energyInterval = null;
  let totalTaps = 0;
  let playTime = 0;
  let playTimeInterval = null;
  let autoTappers = 0;
  let autoTapperInterval = null;
  let friendsCount = 0;
  let achievements = [];
  let refEarnings = 0;
  let lastAdWatchTime = 0;
  const AD_COOLDOWN = 900; // 15 minutes in seconds
  
  // Check if user is referred
  const urlParams = new URLSearchParams(window.location.search);
  const refCode = urlParams.get('start');
  let referredBy = null;
  
  if (refCode && refCode.length > 5) {
    referredBy = refCode;
    // Give referral bonus to both users
    points += 50;
    // Mark as completed referral task
    if (!completedTasks.includes('referred')) {
      completedTasks.push('referred');
    }
  }

  let shopItems = {
    autoTappers: [
      {id: 'auto1', name: 'Basic Auto Tapper', desc: 'Automatically taps once every 10 seconds', price: 500, value: 1, owned: 0},
      {id: 'auto2', name: 'Advanced Auto Tapper', desc: 'Automatically taps 3 times every 10 seconds', price: 2000, value: 3, owned: 0},
      {id: 'auto3', name: 'Pro Auto Tapper', desc: 'Automatically taps 10 times every 10 seconds', price: 10000, value: 10, owned: 0}
    ],
    energy: [
      {id: 'energy1', name: 'Energy Pack', desc: '+50 maximum energy', price: 300, value: 50, owned: 0},
      {id: 'energy2', name: 'Energy Boost', desc: '+100 maximum energy', price: 800, value: 100, owned: 0},
      {id: 'energy3', name: 'Energy Surge', desc: '+200 maximum energy', price: 2000, value: 200, owned: 0}
    ],
    multipliers: [
      {id: 'multi1', name: '2x Multiplier (1h)', desc: 'Double your tap earnings for 1 hour', price: 25000, value: 2, duration: 3600, active: false}
    ]
  };
  
  let activeMultiplier = { value: 1, expires: 0 };

  const $ = (id)=>document.getElementById(id);
  const pointsBalance=$('pointsBalance'), walletBalance=$('walletBalance');
  const energyDisplay=$('energyDisplay'), energyBarFill=$('energyBarFill');
  const tapper=$('tapperObject');
  const tapperClickArea = $('tapperClickArea');
  const particlesContainer = $('particles');
  const tapEffectsContainer = $('tapEffects');
  const multiplierBadge = $('multiplierBadge');

  // Format numbers with K, M, B suffixes
  function formatNumber(num) {
    if (num >= 1000000000) {
      return (num / 1000000000).toFixed(1).replace(/\.0$/, '') + 'B';
    }
    if (num >= 1000000) {
      return (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
    }
    if (num >= 1000) {
      return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'K';
    }
    return num;
  }

  function save(){
    const userData = {
      points,energy,maxEnergy,multitap,completedTasks,boostsLevel,
      totalTaps, playTime, autoTappers, friendsCount, achievements,
      shopItems, activeMultiplier, lastAdWatchTime, refEarnings
    };
    
    // Store data with user-specific key if we have Telegram user ID
    const storageKey = window.Telegram?.WebApp?.initDataUnsafe?.user?.id ? 
      `cxData_${window.Telegram.WebApp.initDataUnsafe.user.id}` : 'cxData';
    
    localStorage.setItem(storageKey, JSON.stringify(userData));
  }
  
  function load(){
    try{
      // Use user-specific key if we have Telegram user ID
      const storageKey = window.Telegram?.WebApp?.initDataUnsafe?.user?.id ? 
        `cxData_${window.Telegram.WebApp.initDataUnsafe.user.id}` : 'cxData';
        
      const raw = localStorage.getItem(storageKey);
      if(!raw) return;
      
      const d = JSON.parse(raw) || {};
      points = Number.isFinite(d.points) ? d.points : 0;
      energy = Number.isFinite(d.energy) ? d.energy : 10;
      maxEnergy = Number.isFinite(d.maxEnergy) ? d.maxEnergy : 100;
      multitap = Number.isFinite(d.multitap) ? d.multitap : 1;
      boostsLevel = d.boostsLevel || { multitap: 1, energy: 1, regen: 1 };
      completedTasks = Array.isArray(d.completedTasks) ? d.completedTasks : [];
      totalTaps = Number.isFinite(d.totalTaps) ? d.totalTaps : 0;
      playTime = Number.isFinite(d.playTime) ? d.playTime : 0;
      autoTappers = Number.isFinite(d.autoTappers) ? d.autoTappers : 0;
      friendsCount = Number.isFinite(d.friendsCount) ? d.friendsCount : 0;
      achievements = Array.isArray(d.achievements) ? d.achievements : [];
      shopItems = d.shopItems || shopItems;
      activeMultiplier = d.activeMultiplier || { value: 1, expires: 0 };
      lastAdWatchTime = Number.isFinite(d.lastAdWatchTime) ? d.lastAdWatchTime : 0;
      refEarnings = Number.isFinite(d.refEarnings) ? d.refEarnings : 0;
    } catch(e) { 
      console.warn('load fail',e); 
    }
  }

  function update(){
    if(maxEnergy <= 0) maxEnergy = 100;                
    if(energy > maxEnergy) energy = maxEnergy;
    
    pointsBalance.textContent = formatNumber(Math.floor(points));
    walletBalance.textContent = formatNumber(Math.floor(points));
    energyDisplay.textContent = `${Math.floor(energy)} / ${maxEnergy}`;
    energyBarFill.style.width = (energy/maxEnergy*100)+'%';
    $('profileBalance').textContent = formatNumber(Math.floor(points));
    $('profileEnergy').textContent = `${Math.floor(energy)}/${maxEnergy}`;
    $('profileMultitap').textContent = multitap;
    $('profileTaps').textContent = formatNumber(totalTaps);
    $('profilePlayTime').textContent = Math.floor(playTime/60)+'m';
    $('multitapStat').textContent = multitap;
    $('energyRegenStat').textContent = (1000/BOOSTS_CONFIG.regen.effect(boostsLevel.regen)).toFixed(1)+'/s';
    $('totalTapsStat').textContent = formatNumber(totalTaps);
    $('friendsCount').textContent = friendsCount;
    $('friendsBonus').textContent = friendsCount * 1; // 1% per friend
    $('refEarnings').textContent = formatNumber(refEarnings);
    
    // Update referral link with user's referral code
    if (window.Telegram?.WebApp?.initDataUnsafe?.user?.id) {
      const userId = window.Telegram.WebApp.initDataUnsafe.user.id;
      $('refLink').textContent = `http://t.me/Official_CloneX_Bot/clonex?start=ref${userId}`;
    }
    
    // Update progress ring
    const circle = document.querySelector('.progress-ring-circle');
    if (circle) {
      const radius = circle.r.baseVal.value;
      const circumference = radius * 2 * Math.PI;
      circle.style.strokeDasharray = `${circumference} ${circumference}`;
      circle.style.strokeDashoffset = `${circumference - (energy/maxEnergy * circumference)}`;
    }
    
    // Update multiplier badge
    if (activeMultiplier.value > 1) {
      multiplierBadge.textContent = activeMultiplier.value + 'x Active';
      multiplierBadge.style.display = 'block';
    } else {
      multiplierBadge.style.display = 'none';
    }
    
    // Update ad cooldown timer
    updateAdCooldown();
    
    save();
  }
  
  function updateAdCooldown() {
    const now = Math.floor(Date.now() / 1000);
    const timeSinceLastAd = now - lastAdWatchTime;
    const cooldownRemaining = AD_COOLDOWN - timeSinceLastAd;
    
    if (cooldownRemaining > 0) {
      adCooldown = true;
      const minutes = Math.floor(cooldownRemaining / 60);
      const seconds = cooldownRemaining % 60;
      
      // Update ad button text with cooldown
      const adButtons = document.querySelectorAll('.ad-task-btn');
      adButtons.forEach(btn => {
        btn.disabled = true;
        btn.innerHTML = `<i class="fas fa-clock"></i> ${minutes}:${seconds.toString().padStart(2, '0')}`;
      });
    } else {
      adCooldown = false;
      
      // Reset ad button text
      const adButtons = document.querySelectorAll('.ad-task-btn');
      adButtons.forEach(btn => {
        btn.disabled = false;
        btn.innerHTML = `<i class="fas fa-tv"></i> Watch Ad (+50 CX)`;
      });
    }
  }
  
  function createParticles() {
    for (let i = 0; i < 15; i++) {
      const particle = document.createElement('div');
      particle.className = 'particle';
      particle.style.width = Math.random() * 5 + 2 + 'px';
      particle.style.height = particle.style.width;
      particle.style.left = Math.random() * 100 + '%';
      particle.style.animationDelay = Math.random() * 8 + 's';
      particle.style.animationDuration = Math.random() * 5 + 5 + 's';
      particlesContainer.appendChild(particle);
    }
  }
  
  function createTapEffect(x, y) {
    const effect = document.createElement('div');
    effect.className = 'tap-effect';
    effect.style.left = x + 'px';
    effect.style.top = y + 'px';
    tapEffectsContainer.appendChild(effect);
    
    setTimeout(() => {
      effect.remove();
    }, 500);
  }
  
  function floatText(txt){
    const el = document.createElement('div');
    el.className = 'float'; 
    el.textContent = txt;
    $('tapperZone').appendChild(el);
    el.style.left = '50%'; 
    el.style.top = '50%';
    setTimeout(() => el.remove(), 1500);
  }
  
  function errorText(txt){
    const el = document.createElement('div');
    el.className = 'error-float'; 
    el.textContent = txt;
    $('tapperZone').appendChild(el);
    el.style.left = '50%'; 
    el.style.top = '50%';
    setTimeout(() => el.remove(), 1500);
  }
  
  function showAchievement(title, desc, reward) {
    const toast = document.createElement('div');
    toast.className = 'achievement-toast';
    toast.innerHTML = `<i class="fas fa-trophy"></i>
      <div>
        <div><strong>${title}</strong></div>
        <div style="font-size:0.8rem">${desc}</div>
      </div>`;
    document.body.appendChild(toast);
    
    if (reward) {
      points += reward;
      setTimeout(() => {
        floatText('+' + formatNumber(reward) + ' CX');
      }, 1000);
    }
    
    setTimeout(() => {
      toast.remove();
    }, 3000);
    
    update();
  }

  tapperClickArea.addEventListener('click', (e) => {
    // Prevent default to avoid any flash
    e.preventDefault();
    
    if(energy < 1){
      errorText('No Energy!');
      return;
    }
    
    // Create tap effect at click position
    createTapEffect(e.clientX, e.clientY);
    
    // Calculate earnings with multiplier
    const baseEarn = 1;
    const multiplier = activeMultiplier.value;
    const earn = baseEarn * multiplier;
    
    // Subtract energy
    energy -= 1;
    
    // Add points
    points += earn;
    totalTaps += 1;
    
    // Show floating text
    floatText('+' + earn.toFixed(1) + ' CX');
    
    // Check achievements
    checkAchievements();
    
    // Update UI
    update();
  });
  
  function checkAchievements() {
    // Tap achievements
    if (totalTaps >= 100 && !achievements.includes('100_taps')) {
      achievements.push('100_taps');
      showAchievement('First Steps', 'Reach 100 taps', 10);
    }
    if (totalTaps >= 1000 && !achievements.includes('1000_taps')) {
      achievements.push('1000_taps');
      showAchievement('Tapping Pro', 'Reach 1,000 taps', 50);
    }
    if (totalTaps >= 10000 && !achievements.includes('10000_taps')) {
      achievements.push('10000_taps');
      showAchievement('Tapping Master', 'Reach 10,000 taps', 200);
    }
    
    // Points achievements
    if (points >= 1000 && !achievements.includes('1000_points')) {
      achievements.push('1000_points');
      showAchievement('First Thousand', 'Earn 1,000 CX', 50);
    }
    if (points >= 10000 && !achievements.includes('10000_points')) {
      achievements.push('10000_points');
      showAchievement('CX Collector', 'Earn 10,000 CX', 200);
    }
    
    // Energy achievements
    if (maxEnergy >= 200 && !achievements.includes('200_energy')) {
      achievements.push('200_energy');
      showAchievement('Energy Boost', 'Reach 200 max energy', 100);
    }
    if (maxEnergy >= 500 && !achievements.includes('500_energy')) {
      achievements.push('500_energy');
      showAchievement('Energy Master', 'Reach 500 max energy', 500);
    }
  }

  function regenEnergy() {
    if (energy < maxEnergy) {
      const regenRate = BOOSTS_CONFIG.regen.effect(boostsLevel.regen);
      energy = Math.min(maxEnergy, energy + regenRate/10);
      update();
    }
  }
  
  function autoTap() {
    if (autoTappers > 0) {
      const baseEarn = 1;
      const multiplier = activeMultiplier.value;
      const earn = baseEarn * multiplier * autoTappers;
      
      points += earn;
      totalTaps += autoTappers;
      
      update();
    }
  }
  
  function updatePlayTime() {
    playTime += 1;
    update();
  }
  
  function checkMultiplierExpiry() {
    const now = Math.floor(Date.now() / 1000);
    if (activeMultiplier.expires > 0 && now >= activeMultiplier.expires) {
      activeMultiplier = { value: 1, expires: 0 };
      update();
    }
  }
  
  function updateAdTimer() {
    if (adCooldown) {
      updateAdCooldown();
    }
  }

  // Initialize modals
  function initModals(){
    const modals = document.querySelectorAll('.modal');
    const btns = document.querySelectorAll('[id$="Btn"]');
    const closes = document.querySelectorAll('[data-close]');
    
    btns.forEach(b => {
      b.addEventListener('click', () => {
        const id = b.id.replace('Btn','Modal');
        const m = document.getElementById(id);
        if(m){
          m.classList.add('show');
          if(id==='tasksModal') loadTasks();
          if(id==='boostsModal') loadBoosts();
          if(id==='shopModal') loadShop();
        }
      });
    });
    
    closes.forEach(c => {
      c.addEventListener('click', () => {
        const m = c.closest('.modal');
        if(m) m.classList.remove('show');
      });
    });
    
    modals.forEach(m => {
      m.addEventListener('click', (e) => {
        if(e.target === m) m.classList.remove('show');
      });
    });
    
    // Tab functionality
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const tabContainer = tab.closest('.tab-container');
        const tabContentId = tab.dataset.tab + 'Tab';
        
        // Deactivate all tabs in this container
        tabContainer.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        // Activate clicked tab
        tab.classList.add('active');
        
        // Hide all tab content in this container
        tabContainer.parentElement.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        // Show the corresponding content
        document.getElementById(tabContentId).classList.add('active');
      });
    });
  }
  
  // BOOSTS CONFIG
  const BOOSTS_CONFIG = {
    multitap: {
      name: 'Multitap',
      desc: 'Increases taps per click',
      max: 20,
      base: 1,
      effect: (lvl) => 1 + lvl * 0.5,
      price: (lvl) => Math.round(100 * Math.pow(1.5, lvl-1))
    },
    energy: {
      name: 'Max Energy',
      desc: 'Increases maximum energy',
      max: 20,
      base: 100,
      effect: (lvl) => 100 + lvl * 50,
      price: (lvl) => Math.round(200 * Math.pow(1.5, lvl-1))
    },
    regen: {
      name: 'Energy Regen',
      desc: 'Increases energy regeneration rate',
      max: 20,
      base: 0.5,
      effect: (lvl) => 0.5 + lvl * 0.25,
      price: (lvl) => Math.round(300 * Math.pow(1.5, lvl-1))
    }
  };
  
  // Load boosts
  function loadBoosts(){
    const list = $('boostList');
    if (!list) return;
    
    list.innerHTML = '';
    
    for(const [id, config] of Object.entries(BOOSTS_CONFIG)){
      const lvl = boostsLevel[id] || 1;
      const price = config.price(lvl);
      const effect = config.effect(lvl);
      const maxed = lvl >= config.max;
      
      const el = document.createElement('div');
      el.className = 'card';
      el.innerHTML = `
        <div class="info">
          <i class="fas fa-${id==='multitap'?'hand-point-up':id==='energy'?'battery-full':'bolt'}"></i>
          <div>
            <div>${config.name} ${lvl>1?'Lv.'+lvl:''}</div>
            <div style="font-size:.9rem;opacity:.9">${config.desc}</div>
          </div>
        </div>
        <button class="btn" ${maxed||points<price?'disabled':''} data-boost="${id}">
          ${maxed?'MAX':`Upgrade (${formatNumber(price)} CX)`}
        </button>
      `;
      
      if(!maxed){
        el.querySelector('button').addEventListener('click', () => {
          if(points >= price){
            points -= price;
            boostsLevel[id]++;
            
            // Update multitap if this is the multitap boost
            if (id === 'multitap') {
              multitap = BOOSTS_CONFIG.multitap.effect(boostsLevel.multitap);
            }
            
            // Update max energy if this is the energy boost
            if (id === 'energy') {
              maxEnergy = BOOSTS_CONFIG.energy.effect(boostsLevel.energy);
              if (energy > maxEnergy) energy = maxEnergy;
            }
            
            loadBoosts();
            update();
          }
        });
      }
      
      list.appendChild(el);
    }
    
    // Load achievements
    const achList = $('achievementsList');
    if (!achList) return;
    
    achList.innerHTML = '';
    
    const achievementConfig = [
      {id: '100_taps', title: 'First Steps', desc: 'Reach 100 taps', reward: 10},
      {id: '1000_taps', title: 'Tapping Pro', desc: 'Reach 1,000 taps', reward: 50},
      {id: '10000_taps', title: 'Tapping Master', desc: 'Reach 10,000 taps', reward: 200},
      {id: '1000_points', title: 'First Thousand', desc: 'Earn 1,000 CX', reward: 50},
      {id: '10000_points', title: 'CX Collector', desc: 'Earn 10,000 CX', reward: 200},
      {id: '200_energy', title: 'Energy Boost', desc: 'Reach 200 max energy', reward: 100},
      {id: '500_energy', title: 'Energy Master', desc: 'Reach 500 max energy', reward: 500}
    ];
    
    achievementConfig.forEach(ach => {
      const achieved = achievements.includes(ach.id);
      const el = document.createElement('div');
      el.className = 'card';
      el.innerHTML = `
        <div class="info">
          <i class="fas fa-trophy" style="color:${achieved ? 'var(--secondary)' : 'var(--muted)'}"></i>
          <div>
            <div>${ach.title}</div>
            <div style="font-size:.9rem;opacity:.9">${ach.desc}</div>
          </div>
        </div>
        <div style="color:var(${achieved ? '--success' : '--muted'});font-weight:bold">
          ${achieved ? '✓' : formatNumber(ach.reward) + ' CX'}
        </div>
      `;
      achList.appendChild(el);
    });
  }
  
  // Load shop
  function loadShop(){
    // Auto Tappers
    const autoList = $('autoTappersList');
    if (autoList) {
      autoList.innerHTML = '';
      
      shopItems.autoTappers.forEach(item => {
        const el = document.createElement('div');
        el.className = 'shop-item-card';
        el.innerHTML = `
          <div class="shop-item-title">${item.name}</div>
          <div class="shop-item-description">${item.desc}</div>
          <div class="shop-item-price-tag">${formatNumber(item.price)} CX</div>
          <button class="btn shop-item-button" ${points < item.price ? 'disabled' : ''} data-shop="autoTappers" data-id="${item.id}">
            Buy (${item.owned})
          </button>
        `;
        
        el.querySelector('button').addEventListener('click', () => {
          if (points >= item.price) {
            points -= item.price;
            item.owned++;
            autoTappers += item.value;
            loadShop();
            update();
          }
        });
        
        autoList.appendChild(el);
      });
    }
    
    // Energy
    const energyList = $('energyList');
    if (energyList) {
      energyList.innerHTML = '';
      
      shopItems.energy.forEach(item => {
        const el = document.createElement('div');
        el.className = 'shop-item-card';
        el.innerHTML = `
          <div class="shop-item-title">${item.name}</div>
          <div class="shop-item-description">${item.desc}</div>
          <div class="shop-item-price-tag">${formatNumber(item.price)} CX</div>
          <button class="btn shop-item-button" ${points < item.price ? 'disabled' : ''} data-shop="energy" data-id="${item.id}">
            Buy (${item.owned})
          </button>
        `;
        
        el.querySelector('button').addEventListener('click', () => {
          if (points >= item.price) {
            points -= item.price;
            item.owned++;
            maxEnergy += item.value;
            loadShop();
            update();
          }
        });
        
        energyList.appendChild(el);
      });
    }
    
    // Multipliers
    const multiList = $('multipliersList');
    if (multiList) {
      multiList.innerHTML = '';
      
      shopItems.multipliers.forEach(item => {
        const now = Math.floor(Date.now() / 1000);
        const active = activeMultiplier.expires > now;
        
        const el = document.createElement('div');
        el.className = 'shop-item-card';
        el.innerHTML = `
          <div class="shop-item-title">${item.name}</div>
          <div class="shop-item-description">${item.desc}</div>
          <div class="shop-item-price-tag">${formatNumber(item.price)} CX</div>
          <button class="btn shop-item-button" ${points < item.price || active ? 'disabled' : ''} data-shop="multipliers" data-id="${item.id}">
            ${active ? 'Active' : 'Activate'}
          </button>
        `;
        
        if (!active) {
          el.querySelector('button').addEventListener('click', () => {
            if (points >= item.price) {
              points -= item.price;
              activeMultiplier = {
                value: item.value,
                expires: now + item.duration
              };
              loadShop();
              update();
            }
          });
        }
        
        multiList.appendChild(el);
      });
    }
  }
  
  // TASKS CONFIG - Only 3 tasks as requested
  const TASKS_CONFIG = [
    {
      id: 'join_telegram',
      title: 'Join Telegram Channel',
      desc: 'Join our official Telegram channel',
      reward: 100,
      action: () => {
        window.open('https://t.me/CloneX_Updates', '_blank');
        completeTask('join_telegram');
      }
    },
    {
      id: 'follow_x',
      title: 'Follow on X (Twitter)',
      desc: 'Follow our official X account',
      reward: 100,
      action: () => {
        window.open('https://x.com/clonex_updates', '_blank');
        completeTask('follow_x');
      }
    },
    {
      id: 'watch_ad',
      title: 'Watch Advertisement',
      desc: 'Watch an ad to earn extra CX',
      reward: 50,
      cooldown: AD_COOLDOWN,
      action: () => {
        if (adCooldown) {
          errorText('Ad on cooldown!');
          return;
        }
        
        // Simulate watching an ad
        const now = Math.floor(Date.now() / 1000);
        lastAdWatchTime = now;
        points += 50;
        update();
        
        // Show success message
        floatText('+50 CX');
        
        // Update the button state
        updateAdCooldown();
      }
    }
  ];
  
  function loadTasks(){
    const list = $('taskList');
    if (!list) return;
    
    list.innerHTML = '';
    
    TASKS_CONFIG.forEach(task => {
      const completed = completedTasks.includes(task.id);
      const now = Math.floor(Date.now() / 1000);
      const timeSinceLastAd = now - lastAdWatchTime;
      const cooldownRemaining = AD_COOLDOWN - timeSinceLastAd;
      
      const el = document.createElement('div');
      el.className = 'card';
      
      if (task.id === 'watch_ad' && cooldownRemaining > 0) {
        const minutes = Math.floor(cooldownRemaining / 60);
        const seconds = cooldownRemaining % 60;
        
        el.innerHTML = `
          <div class="info">
            <i class="fas fa-${task.id.includes('telegram')?'paper-plane':task.id.includes('x')?'hashtag':'tv'}"></i>
            <div>
              <div>${task.title}</div>
              <div style="font-size:.9rem;opacity:.9">${task.desc}</div>
              <div class="ad-cooldown">Cooldown: ${minutes}:${seconds.toString().padStart(2, '0')}</div>
            </div>
          </div>
          <button class="btn ad-task-btn" disabled>
            <i class="fas fa-clock"></i> ${minutes}:${seconds.toString().padStart(2, '0')}
          </button>
        `;
      } else {
        el.innerHTML = `
          <div class="info">
            <i class="fas fa-${task.id.includes('telegram')?'paper-plane':task.id.includes('x')?'hashtag':'tv'}"></i>
            <div>
              <div>${task.title}</div>
              <div style="font-size:.9rem;opacity:.9">${task.desc}</div>
            </div>
          </div>
          <button class="btn ${task.id === 'watch_ad' ? 'ad-task-btn' : ''}" ${completed?'disabled':''}>
            ${completed?'Claimed':task.id === 'watch_ad' ? '<i class="fas fa-tv"></i> Watch Ad (+50 CX)' : `+${formatNumber(task.reward)} CX`}
          </button>
        `;
      }
      
      if(!completed){
        el.querySelector('button').addEventListener('click', task.action);
      }
      
      list.appendChild(el);
    });
  }
  
  function completeTask(id){
    if(completedTasks.includes(id)) return;
    const task = TASKS_CONFIG.find(t => t.id === id);
    if(!task) return;
    
    completedTasks.push(id);
    points += task.reward;
    floatText('+'+formatNumber(task.reward)+' CX');
    loadTasks();
    update();
  }
  
  // Initialize Telegram WebApp
  function initTelegram() {
    if (window.Telegram && Telegram.WebApp) {
      Telegram.WebApp.ready();
      Telegram.WebApp.expand();
      
      const user = Telegram.WebApp.initDataUnsafe?.user;
      if (user) {
        // Update profile information
        $('usernameDisplay').textContent = user.first_name || user.username || 'User';
        $('profileUsername').textContent = user.first_name || user.username || 'User';
        
        if (user.photo_url) {
          $('profilePic').src = user.photo_url;
        }
        
        // Check if user was referred
        if (referredBy) {
          // Add referral bonus
          points += 50;
          friendsCount += 1;
          floatText('Referral bonus +50 CX!');
          update();
        }
      }
      
      // Set up back button behavior
      Telegram.WebApp.BackButton.onClick(closeAllModals);
      Telegram.WebApp.BackButton.show();
    }
  }
  
  function closeAllModals() {
    document.querySelectorAll('.modal').forEach(m => m.classList.remove('show'));
  }
  
  // Initialize
  function init(){
    load();
    update();
    initModals();
    initTelegram();
    createParticles();
    
    // Set up intervals
    energyInterval = setInterval(regenEnergy, 100);
    autoTapperInterval = setInterval(autoTap, 10000);
    playTimeInterval = setInterval(updatePlayTime, 1000);
    setInterval(checkMultiplierExpiry, 1000);
    setInterval(updateAdTimer, 1000);
    
    // Initialize shop and tasks
    loadShop();
    loadTasks();
    loadBoosts();
    
    // Copy referral link
    $('copyRef').addEventListener('click', () => {
      navigator.clipboard.writeText($('refLink').textContent);
      floatText('Copied!');
    });
  }
  
  // Start the game
  init();
})();
</script>
</body>
</html>